# Google Analytics 4 カスタムディメンション・指標設定ガイド

## 概要
ポケしりゲームの統計機能を正常に動作させるために必要なGoogle Analytics 4の設定手順を説明します。

## 前提条件
- Google Analytics 4 プロパティが作成済み
- 管理者権限を持つGoogleアカウント
- ゲームが既にGA4にイベントを送信している状態

## 設定手順

### 1. Google Analytics 4 管理画面にアクセス

1. [Google Analytics](https://analytics.google.com/) にログイン
2. 該当のプロパティを選択
3. 左サイドバーから「管理」をクリック

### 2. カスタムディメンションの設定

#### 2.1 カスタムディメンション画面を開く
1. **管理** → **カスタム定義** → **カスタムディメンション** をクリック
2. 「カスタムディメンションを作成」をクリック

#### 2.2 Game Mode ディメンションの作成
- **ディメンション名**: `Game Mode`
- **範囲**: `イベント`
- **イベントパラメータ**: `game_mode`
- **説明**: `ゲームモード（シングル/タイムアタック）`
- 「作成」をクリック

#### 2.3 Pokemon Name ディメンションの作成
- **ディメンション名**: `Pokemon Name`
- **範囲**: `イベント`
- **イベントパラメータ**: `pokemon_name`
- **説明**: `回答されたポケモン名`
- 「作成」をクリック

### 3. カスタム指標の設定

#### 3.1 カスタム指標画面を開く
1. **管理** → **カスタム定義** → **カスタム指標** をクリック
2. 「カスタム指標を作成」をクリック

#### 3.2 Score 指標の作成
- **指標名**: `Score`
- **範囲**: `イベント`
- **イベントパラメータ**: `score`
- **測定単位**: `標準`
- **説明**: `ゲーム終了時の最終スコア`
- 「作成」をクリック

#### 3.3 Chain Length 指標の作成
- **指標名**: `Chain Length`
- **範囲**: `イベント`
- **イベントパラメータ**: `chain_length`
- **測定単位**: `標準`
- **説明**: `つないだポケモンの数`
- 「作成」をクリック

### 4. 設定確認

#### 4.1 作成されたディメンション・指標の確認
以下が正しく作成されていることを確認：

**カスタムディメンション**:
- Game Mode (`game_mode`)
- Pokemon Name (`pokemon_name`)

**カスタム指標**:
- Score (`score`)
- Chain Length (`chain_length`)

#### 4.2 データ反映の待機
- カスタムディメンション・指標の反映には**最大24時間**かかる場合があります
- 設定後すぐにはデータが表示されない可能性があります

### 5. 動作確認

#### 5.1 リアルタイムレポートでの確認
1. **レポート** → **リアルタイム** を開く
2. ゲームをプレイして、イベントが送信されることを確認
3. カスタムパラメータが正しく送信されていることを確認

#### 5.2 統計データ取得の確認
1. GitHub Actionsの統計更新を手動実行
2. `public/stats.json` でモード別データが取得されることを確認
3. 統計モーダルで正しく表示されることを確認

### 6. レポートでの活用方法

#### 6.1 カスタムレポートの作成
1. **レポート** → **エンゲージメント** → **イベント** を開く
2. 「game_clear」や「game_over」イベントをクリック
3. 右上の「カスタマイズ」から「ディメンション」を追加
4. 作成したカスタムディメンションを選択

#### 6.2 分析可能なデータ
- **ゲームモード別の成功率**
- **モード別の平均スコア・最高スコア**
- **モード別の平均チェーン長・最長チェーン**
- **人気ポケモンランキング**
- **時間帯別のプレイ傾向**
- **デバイス別の成績**

### 7. トラブルシューティング

#### 7.1 データが表示されない場合
**原因と対処法**:
- **設定直後**: 24時間待機
- **パラメータ名の不一致**: イベントパラメータ名を再確認
- **イベント送信エラー**: ブラウザの開発者ツールでネットワークタブを確認
- **権限不足**: GA4プロパティの管理者権限を確認

#### 7.2 統計スクリプトエラーの場合
**確認項目**:
- カスタムディメンション・指標が正しく作成されているか
- GA4 Property ID が正しく設定されているか
- サービスアカウントの権限が適切か

#### 7.3 よくあるエラーメッセージ
```
⚠️ カスタムディメンション・指標の取得に失敗
💡 カスタムディメンション・指標が正しく設定されていない可能性があります
```
→ 上記の設定手順を再確認してください

### 8. 制限事項

#### 8.1 GA4の制限
- **カスタムディメンション**: 1プロパティあたり最大50個
- **カスタム指標**: 1プロパティあたり最大50個
- **データ保持期間**: 最大14ヶ月（設定により変更可能）

#### 8.2 データの注意点
- 設定後から蓄積されるため、過去のデータには適用されません
- リアルタイムデータと標準レポートで表示タイミングが異なります
- サンプリングが適用される場合があります（大量データ時）

### 9. メンテナンス

#### 9.1 定期確認項目
- [ ] 統計データが正常に更新されているか（3時間ごと）
- [ ] エラーログの確認
- [ ] ディメンション・指標の使用状況確認

#### 9.2 アップデート時の注意点
- 新しいパラメータを追加する場合は、対応するディメンション・指標も作成
- パラメータ名を変更する場合は、GA4設定も同時に更新

## 関連リンク

- [Google Analytics 4 ヘルプ](https://support.google.com/analytics/answer/10075209)
- [カスタムディメンションとカスタム指標について](https://support.google.com/analytics/answer/10075209)
- [Data API v1 リファレンス](https://developers.google.com/analytics/devguides/reporting/data/v1)

## 更新履歴

| 日付 | 更新内容 | 更新者 |
|------|----------|--------|
| 2025-10-02 | 初版作成 | 開発チーム |

---

**重要**: この設定は本番環境に影響を与えます。設定前に必ずテスト環境での動作確認を行ってください。
