name: Update Game Statistics

on:
  # 3æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆåŸºæœ¬çµ±è¨ˆï¼‰
  schedule:
    - cron: '0 */3 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

# GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™
permissions:
  contents: write  # stats.jsonã®æ›´æ–°ã¨ã‚³ãƒŸãƒƒãƒˆã«å¿…è¦
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-stats-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ“Š Fetch Analytics Data
      env:
        GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
        GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
        GOOGLE_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_PRIVATE_KEY_ID }}
        GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      run: |
        echo "ğŸ” Google Analytics ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­..."
        node scripts/fetch-stats.js
        
    - name: ğŸ’¾ Commit and Push Updated Stats
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/stats.json
        if git diff --staged --quiet; then
          echo "ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
        else
          git commit -m "ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
        fi
        
    - name: ğŸ—ï¸ Build Next.js application
      env:
        NODE_ENV: production
      run: |
        echo "ğŸ—ï¸ Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        npm run build
        
    - name: ğŸ“¤ Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./out
        
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: âœ… Deployment Summary
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ!"
        echo "ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"
        echo "ğŸŒ ã‚µã‚¤ãƒˆURL: ${{ steps.deployment.outputs.page_url }}"
