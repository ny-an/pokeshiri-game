name: Update Game Statistics

on:
  # 3時間ごとに実行（基本統計）
  schedule:
    - cron: '0 */3 * * *'
  
  # 手動実行も可能
  workflow_dispatch:

# GitHub Pagesへのデプロイ権限
permissions:
  contents: write  # stats.jsonの更新とコミットに必要
  pages: write
  id-token: write

# 同時実行を防ぐ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-stats-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
      
    - name: 📊 Fetch Analytics Data
      env:
        GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
        GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
        GOOGLE_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_PRIVATE_KEY_ID }}
        GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      run: |
        echo "🔍 Google Analytics データを取得中..."
        node scripts/fetch-stats.js
        
    - name: 💾 Commit and Push Updated Stats
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/stats.json
        if git diff --staged --quiet; then
          echo "📊 統計データに変更はありません"
        else
          git commit -m "📊 統計データを自動更新 - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "✅ 統計データを更新しました"
        fi
        
    - name: 🏗️ Build Next.js application
      env:
        NODE_ENV: production
      run: |
        echo "🏗️ Next.js アプリケーションをビルド中..."
        npm run build
        
    - name: 📤 Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./out
        
    - name: 🚀 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ✅ Deployment Summary
      run: |
        echo "🎉 デプロイが完了しました!"
        echo "📊 統計データが更新されました"
        echo "🌐 サイトURL: ${{ steps.deployment.outputs.page_url }}"
